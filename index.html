<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR.js Multi-Marker App</title>
  <!-- A-Frame –∏ AR.js -->
  <script src="lib/aframe.min.js"></script>
  <script src="lib/aframe-ar.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    #loading {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px;
      z-index: 9999;
    }
    .sound-button {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      padding: 12px 24px; font-size: 16px; background: #ff4d4d; color: white;
      border: none; border-radius: 50px; cursor: pointer; z-index: 9999;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      opacity: 0; transition: opacity 0.3s ease;
    }
    .sound-button.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ AR-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</div>

  <a-scene
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <!-- –ö–∞–º–µ—Ä–∞ -->
    <a-entity camera></a-entity>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ -->
    <a-entity id="marker-container"></a-entity>
  </a-scene>

  <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
  <button id="global-sound-button" class="sound-button">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>

  <script>
    const container = document.getElementById('marker-container');
    const loadingDiv = document.getElementById('loading');
    const soundButton = document.getElementById('global-sound-button');

    // –§–ª–∞–≥: –∑–≤—É–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    let userInteracted = false;

    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –∑–≤—É–∫–∞
    function showSoundButton() {
      soundButton.classList.add('visible');
    }

    // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –∑–≤—É–∫–∞
    function hideSoundButton() {
      soundButton.classList.remove('visible');
    }

    // –†–∞–∑—Ä–µ—à–∏—Ç—å –∑–≤—É–∫ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞
    soundButton.addEventListener('click', () => {
      userInteracted = true;
      hideSoundButton();
      // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∑–≤—É–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∂–¥–∞–ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
      document.querySelectorAll('a-sound[data-waiting]').forEach(soundEl => {
        soundEl.components.sound.playSound();
        soundEl.removeAttribute('data-waiting');
      });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞
    fetch('config.json')
      .then(response => response.json())
      .then(config => {
        if (!config.markers || config.markers.length === 0) {
          throw new Error('–ú–∞—Ä–∫–µ—Ä—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã');
        }

        config.markers.forEach((item, index) => {
          const marker = document.createElement('a-marker');

          if (item.patternUrl) {
            marker.setAttribute('type', 'pattern');
            marker.setAttribute('url', item.patternUrl);
          } else {
            marker.setAttribute('preset', item.marker);
          }

          // –≠–ª–µ–º–µ–Ω—Ç –∑–≤—É–∫–∞
          const soundEl = document.createElement('a-sound');
          soundEl.setAttribute('src', item.sound);
          soundEl.setAttribute('autoplay', false);
          soundEl.setAttribute('positional', false);
          soundEl.setAttribute('volume', '0.8');
          marker.appendChild(soundEl);

          // 3D –º–æ–¥–µ–ª—å
          const model = document.createElement('a-entity');
          model.setAttribute('gltf-model', item.model);
          model.setAttribute('scale', item.scale || '1 1 1');
          model.setAttribute('position', '0 0 0');
          model.setAttribute('animation', item.animation || 'property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear');
          marker.appendChild(model);

          // –§–ª–∞–≥: –∑–≤—É–∫ —É–∂–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª—Å—è –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
          let soundRequestedForMarker = false;

          marker.addEventListener('markerFound', () => {
            if (!userInteracted && !soundRequestedForMarker) {
              showSoundButton();
              soundRequestedForMarker = true;
            }

            if (userInteracted) {
              soundEl.components.sound.playSound();
            } else {
              soundEl.setAttribute('data-waiting', 'true');
            }
          });

          marker.addEventListener('markerLost', () => {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Å–Ω–æ–≤–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ
            soundRequestedForMarker = false;
            // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–≤—É–∫
            // soundEl.components.sound.stopSound();
          });

          container.appendChild(marker);
        });

        loadingDiv.style.display = 'none';
      })
      .catch(err => {
        console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –ø—É—Å—Ç–æ–π config.json:', err);

        // –°–æ–∑–¥–∞—ë–º –∑–∞–≥–ª—É—à–∫—É
        const fallbackMarker = document.createElement('a-marker');
        fallbackMarker.setAttribute('preset', 'hiro');

        const fallbackModel = document.createElement('a-box');
        fallbackModel.setAttribute('color', '#FF6347');
        fallbackModel.setAttribute('depth', 0.2);
        fallbackModel.setAttribute('height', 0.2);
        fallbackModel.setAttribute('width', 0.2);
        fallbackModel.setAttribute('position', '0 0 0');
        fallbackModel.setAttribute('animation', 'property: rotation; to: 360 360 360; loop: true; dur: 3000; easing: linear');

        const text = document.createElement('a-text');
        text.setAttribute('value', '–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        text.setAttribute('align', 'center');
        text.setAttribute('color', 'white');
        text.setAttribute('position', '0 0.3 0');
        text.setAttribute('scale', '1.5 1.5 1.5');

        fallbackMarker.appendChild(fallbackModel);
        fallbackMarker.appendChild(text);

        container.appendChild(fallbackMarker);

        loadingDiv.innerText = '‚ö†Ô∏è –ö–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø–æ–∫–∞–∑–∞–Ω–∞ –∑–∞–≥–ª—É—à–∫–∞';
        setTimeout(() => {
          loadingDiv.style.display = 'none';
        }, 2000);
      });
  </script>
</body>
</html>
