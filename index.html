<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>AR.js Multi-Marker App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Локальные библиотеки -->
  <script src="lib/aframe.min.js"></script>
  <script src="lib/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
    #loading {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7); color: #fff; padding: 12px 20px;
      border-radius: 6px; font-family: sans-serif; z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="loading">Загрузка...</div>

  <a-scene
    vr-mode-ui="enabled: false"
    renderer="antialias: true; logarithmicDepthBuffer: true"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-entity camera></a-entity>
    <a-entity id="marker-container"></a-entity>
  </a-scene>

  <script>
    const container = document.getElementById("marker-container");
    const loadingDiv = document.getElementById("loading");

    fetch("config.json")
      .then(r => r.json())
      .then(config => {
        config.markers.forEach(item => {
          const marker = document.createElement("a-marker");
          marker.setAttribute("type", "pattern");
          marker.setAttribute("url", item.patternUrl);

          // модель
          const model = document.createElement("a-entity");
          model.setAttribute("gltf-model", item.model);
          if (item.scale) model.setAttribute("scale", item.scale);
          model.setAttribute("animation", "property: rotation; to: 0 360 0; loop: true; dur: 6000; easing: linear");
          marker.appendChild(model);

          // звук (если указан)
          if (item.sound) {
            const soundEl = document.createElement("a-sound");
            soundEl.setAttribute("src", item.sound);
            soundEl.setAttribute("autoplay", false);
            soundEl.setAttribute("positional", false);
            marker.appendChild(soundEl);

            marker.addEventListener("markerFound", () => {
              soundEl.components.sound.playSound();
            });
            marker.addEventListener("markerLost", () => {
              soundEl.components.sound.stopSound();
            });
          }

          container.appendChild(marker);
        });

        loadingDiv.style.display = "none";
      })
      .catch(err => {
        console.warn("Ошибка config.json:", err);
        loadingDiv.textContent = "⚠️ Ошибка загрузки конфигурации";
      });
  </script>
</body>
</html>
