<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR.js Multi-Marker App</title>

  <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="lib/aframe.min.js"></script>
  <script src="lib/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    .a-canvas {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      z-index: 1;
      object-fit: cover;
    }

    #loading {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px;
      z-index: 9999;
    }

    .sound-button {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      padding: 12px 24px; font-size: 16px; background: #ff4d4d; color: white;
      border: none; border-radius: 50px; cursor: pointer; z-index: 9999;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      opacity: 0; transition: opacity 0.3s ease;
    }

    .sound-button.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ AR-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</div>

  <!-- üéØ –°—Ü–µ–Ω–∞: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî —á—ë—Ç–∫–æ—Å—Ç—å + —Ç—Ä–µ–∫–∏–Ω–≥ -->
  <a-scene
    vr-mode-ui="enabled: false"
    renderer="antialias: true; colorManagement: true; logarithmicDepthBuffer: true;"
    arjs="trackingMethod: best; sourceType: webcam;
           sourceWidth: 1024; sourceHeight: 768;
           displayWidth: auto; displayHeight: auto;
           detectionMode: mono_and_matrix;
           matrixCodeType: 3x3;
           canvasInsertMode: append;
           debugUIEnabled: false;"
    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
  >
    <a-entity camera="active: true; fov: 60;" look-controls="enabled: false" wasd-controls="enabled: false"></a-entity>
    <a-entity id="marker-container"></a-entity>
  </a-scene>

  <button id="global-sound-button" class="sound-button">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>

  <script>
    // üß≠ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±—Ä–∞—É–∑–µ—Ä
    function getBrowser() {
      const ua = navigator.userAgent;
      if (ua.includes('YaBrowser')) return 'yandex';
      if (ua.includes('Edg')) return 'edge';
      if (ua.includes('Chrome') && !ua.includes('Edg')) return 'chrome';
      if (ua.includes('Safari') && !ua.includes('Chrome')) return 'safari';
      return 'other';
    }

    // üìè –£–º–Ω—ã–π –º–∞—Å—à—Ç–∞–±: –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ devicePixelRatio
    const baseDpr = 2.0; // "—ç—Ç–∞–ª–æ–Ω–Ω—ã–π" DPR, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π –±–µ—Ä—ë–º –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–±
    const actualDpr = window.devicePixelRatio || 1;
    const dprFix = baseDpr / actualDpr;

    const browserScaleFix = {
      yandex: 0.95 * dprFix,  // —á—É—Ç—å —É–º–µ–Ω—å—à–∞–µ–º –≤ –Ø–Ω–¥–µ–∫—Å–µ + –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è DPR
      chrome: 1.0 * dprFix,
      safari: 1.0 * dprFix,
      edge: 1.0 * dprFix,
      other: 1.0 * dprFix
    };

    const browserFix = browserScaleFix[getBrowser()] || 1.0;

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const container = document.getElementById('marker-container');
    const loadingDiv = document.getElementById('loading');
    const soundButton = document.getElementById('global-sound-button');

    let userInteracted = false;

    function showSoundButton() {
      soundButton.classList.add('visible');
    }

    function hideSoundButton() {
      soundButton.classList.remove('visible');
    }

    soundButton.addEventListener('click', () => {
      userInteracted = true;
      hideSoundButton();
      document.querySelectorAll('a-sound[data-waiting]').forEach(soundEl => {
        soundEl.components.sound.playSound();
        soundEl.removeAttribute('data-waiting');
      });
    });

    // üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    fetch('config.json')
      .then(response => {
        if (!response.ok) throw new Error('config.json –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return response.json();
      })
      .then(config => {
        if (!config.markers || !Array.isArray(config.markers) || config.markers.length === 0) {
          throw new Error('–ú–∞—Ä–∫–µ—Ä—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã');
        }

        config.markers.forEach((item, index) => {
          const marker = document.createElement('a-marker');

          if (item.patternUrl) {
            marker.setAttribute('type', 'pattern');
            marker.setAttribute('url', item.patternUrl);
          } else {
            marker.setAttribute('preset', item.marker);
          }

          // ‚úÖ –†–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–∞ = 1 –º–µ—Ç—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

          const soundEl = document.createElement('a-sound');
          soundEl.setAttribute('src', item.sound);
          soundEl.setAttribute('autoplay', false);
          soundEl.setAttribute('positional', false);
          soundEl.setAttribute('volume', '0.8');
          marker.appendChild(soundEl);

          // üìê –ú–∞—Å—à—Ç–∞–± —Å –ø–æ–ø—Ä–∞–≤–∫–æ–π –Ω–∞ –±—Ä–∞—É–∑–µ—Ä –∏ devicePixelRatio
          let scaleValues = [1, 1, 1];

          if (item.scale) {
            const userScale = item.scale.split(' ').map(Number);
            if (userScale.length === 3) {
              scaleValues = userScale.map(s => s * browserFix);
            }
          } else {
            scaleValues = [browserFix, browserFix, browserFix];
          }

          const model = document.createElement('a-entity');
          model.setAttribute('gltf-model', item.model);
          model.setAttribute('scale', scaleValues.join(' '));
          model.setAttribute('position', '0 0 0');
          model.setAttribute('animation', item.animation || 'property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear');
          marker.appendChild(model);

          let soundRequestedForMarker = false;

          marker.addEventListener('markerFound', () => {
            if (!userInteracted && !soundRequestedForMarker) {
              showSoundButton();
              soundRequestedForMarker = true;
            }

            if (userInteracted) {
              soundEl.components.sound.playSound();
            } else {
              soundEl.setAttribute('data-waiting', 'true');
            }
          });

          marker.addEventListener('markerLost', () => {
            soundRequestedForMarker = false;
          });

          container.appendChild(marker);
        });

        loadingDiv.style.display = 'none';
      })
      .catch(err => {
        console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –ø—É—Å—Ç–æ–π config.json:', err);

        // üîß –ó–∞–≥–ª—É—à–∫–∞
        const fallbackMarker = document.createElement('a-marker');
        fallbackMarker.setAttribute('preset', 'hiro');

        const fallbackModel = document.createElement('a-box');
        fallbackModel.setAttribute('color', '#FF6347');
        fallbackModel.setAttribute('depth', 0.2);
        fallbackModel.setAttribute('height', 0.2);
        fallbackModel.setAttribute('width', 0.2);
        fallbackModel.setAttribute('position', '0 0 0');
        fallbackModel.setAttribute('animation', 'property: rotation; to: 360 360 360; loop: true; dur: 3000; easing: linear');

        const text = document.createElement('a-text');
        text.setAttribute('value', '–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        text.setAttribute('align', 'center');
        text.setAttribute('color', 'white');
        text.setAttribute('position', '0 0.3 0');
        text.setAttribute('scale', '1.5 1.5 1.5');

        fallbackMarker.appendChild(fallbackModel);
        fallbackMarker.appendChild(text);
        container.appendChild(fallbackMarker);

        loadingDiv.innerText = '‚ö†Ô∏è –ö–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø–æ–∫–∞–∑–∞–Ω–∞ –∑–∞–≥–ª—É—à–∫–∞';
        setTimeout(() => {
          loadingDiv.style.display = 'none';
        }, 2000);
      });
  </script>
</body>
</html>
