<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR.js Multi-Marker App</title>

  <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="lib/aframe.min.js"></script>
  <script src="lib/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    /* –§–∏–∫—Å: —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º canvas –±–µ–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π */
    .a-canvas {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      z-index: 1;
      /* –≠—Ç–æ –≤–∞–∂–Ω–æ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
      object-fit: cover;
    }

    #loading {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px;
      z-index: 9999;
    }

    .sound-button {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      padding: 12px 24px; font-size: 16px; background: #ff4d4d; color: white;
      border: none; border-radius: 50px; cursor: pointer; z-index: 9999;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      opacity: 0; transition: opacity 0.3s ease;
    }

    .sound-button.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ AR-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</div>

  <!--
    üîß –ö–ª—é—á–µ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
    - –£–±—Ä–∞–ª–∏ `embedded`, –µ—Å–ª–∏ –æ–Ω –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–∞–∂–µ–Ω–∏—è
    - –Ø–≤–Ω–æ —É–∫–∞–∑–∞–ª–∏ aspect-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    - –î–æ–±–∞–≤–∏–ª–∏ `renderer="colorManagement: true"` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –∏ –º–∞—Å—à—Ç–∞–±–∞
  -->
  <a-scene
    vr-mode-ui="enabled: false"
    renderer="antialias: true; colorManagement: true; logarithmicDepthBuffer: true;"
    arjs="trackingMethod: best; sourceType: webcam;
           sourceWidth: 1280; sourceHeight: 720;
           displayWidth: 1280; displayHeight: 720;
           detectionMode: mono_and_matrix;
           matrixCodeType: 3x3;
           debugUIEnabled: false;"
    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
  >
    <!-- –ö–∞–º–µ—Ä–∞ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º -->
    <a-entity camera look-controls="enabled: false" wasd-controls="enabled: false"></a-entity>

    <a-entity id="marker-container"></a-entity>
  </a-scene>

  <button id="global-sound-button" class="sound-button">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>

  <script>
    const container = document.getElementById('marker-container');
    const loadingDiv = document.getElementById('loading');
    const soundButton = document.getElementById('global-sound-button');

    let userInteracted = false;

    function showSoundButton() {
      soundButton.classList.add('visible');
    }

    function hideSoundButton() {
      soundButton.classList.remove('visible');
    }

    soundButton.addEventListener('click', () => {
      userInteracted = true;
      hideSoundButton();
      document.querySelectorAll('a-sound[data-waiting]').forEach(soundEl => {
        soundEl.components.sound.playSound();
        soundEl.removeAttribute('data-waiting');
      });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    fetch('config.json')
      .then(response => response.json())
      .then(config => {
        if (!config.markers || config.markers.length === 0) {
          throw new Error('–ú–∞—Ä–∫–µ—Ä—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã');
        }

        config.markers.forEach((item, index) => {
          const marker = document.createElement('a-marker');

          if (item.patternUrl) {
            marker.setAttribute('type', 'pattern');
            marker.setAttribute('url', item.patternUrl);
          } else {
            marker.setAttribute('preset', item.marker);
          }

          const soundEl = document.createElement('a-sound');
          soundEl.setAttribute('src', item.sound);
          soundEl.setAttribute('autoplay', false);
          soundEl.setAttribute('positional', false);
          soundEl.setAttribute('volume', '0.8');
          marker.appendChild(soundEl);

          // üîß –§–∏–∫—Å: –µ—Å–ª–∏ scale –∑–∞–¥–∞–Ω –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ "1 1 1", —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∏—Å–ª–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º uniform
          let scale = item.scale || '1 1 1';
          let scaleValues = scale.split(' ').map(Number);
          if (scaleValues.length !== 3) scaleValues = [1, 1, 1];

          // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞–µ–º scale uniform, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è
          // scaleValues = [scaleValues[0], scaleValues[0], scaleValues[0]]; // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

          const model = document.createElement('a-entity');
          model.setAttribute('gltf-model', item.model);
          model.setAttribute('scale', scaleValues.join(' '));
          model.setAttribute('position', '0 0 0');
          model.setAttribute('animation', item.animation || 'property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear');
          marker.appendChild(model);

          let soundRequestedForMarker = false;

          marker.addEventListener('markerFound', () => {
            if (!userInteracted && !soundRequestedForMarker) {
              showSoundButton();
              soundRequestedForMarker = true;
            }

            if (userInteracted) {
              soundEl.components.sound.playSound();
            } else {
              soundEl.setAttribute('data-waiting', 'true');
            }
          });

          marker.addEventListener('markerLost', () => {
            soundRequestedForMarker = false;
          });

          container.appendChild(marker);
        });

        loadingDiv.style.display = 'none';
      })
      .catch(err => {
        console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –ø—É—Å—Ç–æ–π config.json:', err);

        // –ó–∞–≥–ª—É—à–∫–∞ ‚Äî –∫—É–± + —Ç–µ–∫—Å—Ç
        const fallbackMarker = document.createElement('a-marker');
        fallbackMarker.setAttribute('preset', 'hiro');

        const fallbackModel = document.createElement('a-box');
        fallbackModel.setAttribute('color', '#FF6347');
        fallbackModel.setAttribute('depth', 0.2);
        fallbackModel.setAttribute('height', 0.2);
        fallbackModel.setAttribute('width', 0.2);
        fallbackModel.setAttribute('position', '0 0 0');
        fallbackModel.setAttribute('animation', 'property: rotation; to: 360 360 360; loop: true; dur: 3000; easing: linear');

        const text = document.createElement('a-text');
        text.setAttribute('value', '–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        text.setAttribute('align', 'center');
        text.setAttribute('color', 'white');
        text.setAttribute('position', '0 0.3 0');
        text.setAttribute('scale', '1.5 1.5 1.5');

        fallbackMarker.appendChild(fallbackModel);
        fallbackMarker.appendChild(text);
        container.appendChild(fallbackMarker);

        loadingDiv.innerText = '‚ö†Ô∏è –ö–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø–æ–∫–∞–∑–∞–Ω–∞ –∑–∞–≥–ª—É—à–∫–∞';
        setTimeout(() => {
          loadingDiv.style.display = 'none';
        }, 2000);
      });
  </script>
</body>
</html>
